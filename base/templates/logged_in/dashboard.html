{% extends 'base.html' %}
{% load static %}
{% load bootstrap3 %}
{{ form.media }}
{% load render_table from django_tables2 %}

{% block content %}

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.16/af-2.2.2/b-1.4.2/r-2.2.0/sc-1.4.3/sl-1.2.3/datatables.min.css"/>

<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.16/af-2.2.2/b-1.4.2/r-2.2.0/sc-1.4.3/sl-1.2.3/datatables.min.js"></script>

<script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />


<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">Dashboard</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
    <div class="row">
        <div class="col-lg-6 col-md-6">
            <form id="form-select" method="post" action="{% url 'graph' %}">
                <div class="hide">{% bootstrap_field form_select.dumpsters %}</div>
                <a id="graph" href="#">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-area-chart fa-5x"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge">Graph Selected Dumpsters</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </form>
        </div>
        <div class="col-lg-6 col-md-6">
            <a id="make-route" href="#">
                <div class="panel panel-green">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-xs-3">
                                <i class="fa fa-road fa-5x"></i>
                            </div>
                            <div class="col-xs-9 text-right">
                                <div class="huge">Route Selected Dumpsters</div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <div class="row">
        <div id="table" class="col-md-6" style="visibility:hidden">
            {% include 'table.html' %}
        </div>
        <div class="col-md-6">
            <div id='map' style='width: 100%; height: 100%;'></div>
        </div>
    </div>
</div>
<script>
  L.mapbox.accessToken = 'pk.eyJ1IjoidHJhc2hyIiwiYSI6ImNqOHJ3MDBzZjAyZTgzNG1yNHpmZDl3Y2sifQ.q574EBc3GMSMHBH2sPGM6w';
  var map = new L.mapbox.Map('map', 'mapbox.streets').setView([{{lat}},{{long}}], 14)

var myLayer = L.mapbox.featureLayer().addTo(map);

myLayer.setGeoJSON({{layer|safe}});

map.on('load', function () {

    // When a click event occurs on a feature in the dumpsters layer, open a popup at the
    // location of the feature, with description HTML from its properties.
    map.on('click', 'dumpsters', function (e) {
        new mapboxgl.Popup()
            .setLngLat(e.features[0].geometry.coordinates)
            .setHTML(e.features[0].properties.description)
            .addTo(map);
    });
    map.on("mousemove", "state-fills", function(e) {
        map.setFilter("state-fills-hover", ["==", "name", e.features[0].properties.name]);
    });
    // Change the cursor to a pointer when the mouse is over the places layer.
    map.on('mouseenter', 'dumpsters', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'dumpsters', function () {
        map.getCanvas().style.cursor = '';
    });
});
</script>
<script>
$.fn.dataTable.ext.search.push(
  function( settings, data, dataIndex ) {
    $('#min').css('margin-bottom', '10px')
    $('#max').css('margin-bottom', '10px')
    var min = parseInt( $('#min').val(), 0 );
    var max = parseInt( $('#max').val(), 0 );
    var percent_fill = parseFloat( data[3] ) || 0;
  
    if ( ( isNaN( min )          && isNaN( max ) ) ||
         ( isNaN( min )          && percent_fill <= max ) ||
         ( min <= percent_fill   && isNaN( max ) ) ||
         ( min <= percent_fill   && percent_fill <= max ) ) {
      return true;
    }
    return false;
  }
);
$(document).ready(function() {
  var table = $('#dumpster-table').DataTable( {
    responsive:     true,
    columnDefs: [
     { responsivePriority: 1, targets: 0 },
     { responsivePriority: 1, targets: -1 },
     { responsivePriority: 3, targets: 2 },
     {
    } ],
    select: {
      style: 'multi',
    },
    order: [[ 3, 'desc' ]],
    dom: 'Bfrtip',
    buttons: [
        {
            extend: 'selectAll',
            className: 'selectall',
            action : function(e) {
                e.preventDefault();
                table.rows({ page: 'all'}).nodes().each(function() {
                    $(this).removeClass('selected')
                })
                table.rows({ search: 'applied'}).select();
            }
        },
        'selectNone',
    ],
    language: {
        buttons: {
            selectAll: "Select all",
            selectNone: "Select none"
        }
    },
  } );
  $('#min, #max').keyup(function() {
    table.draw();
  });

  $('#graph').click(function() {
    var arr = new Array(1000)
    var count = 0;
    $.map(table.rows('.selected').data(), function (item) {
      arr[count] = $(this).val();
      count++;
    });
    $('[name=dumpsters]').val(arr);
    $('#form-select').submit();
  });

  $('#make-route').click(function () {
    var arr = '['
    var count = 0;
    $.map(table.rows('.selected').data(), function (item) {
      arr += $(this).val() + ','
      count++;
    });
    arr += ']'
    $.ajax({
      url: "get_route_data",
      data: arr,
      success: function(result){
        $("#map").html(result);
    }});
  });

  $('#table').css('visibility', 'visible');
  $('#map').css('height', $('#table').css('height'));
} );

</script>
<style type="text/css">
@keyframes lds-eclipse {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  50% {
    -webkit-transform: rotate(180deg);
    transform: rotate(180deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@-webkit-keyframes lds-eclipse {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  50% {
    -webkit-transform: rotate(180deg);
    transform: rotate(180deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
.lds-eclipse {
  position: relative;
}
.lds-eclipse div {
  position: absolute;
  -webkit-animation: lds-eclipse 1s linear infinite;
  animation: lds-eclipse 1s linear infinite;
  width: 160px;
  height: 160px;
  top: 20px;
  left: 20px;
  border-radius: 50%;
  box-shadow: 0 4px 0 0 #2f98bb;
  -webkit-transform-origin: 80px 82px;
  transform-origin: 80px 82px;
}
.lds-eclipse {
  width: 200px !important;
  height: 200px !important;
  -webkit-transform: translate(-100px, -100px) scale(1) translate(100px, 100px);
  transform: translate(-100px, -100px) scale(1) translate(100px, 100px);
}
.hide {
  display: none;
}
.leaflet-marker-icon {
  height: 40px; !important
  width:15px; !important
}
#map {
position: relative; !important
top: 0;
bottom: 0;
width: 100%;
}
</style>
{% endblock %}

