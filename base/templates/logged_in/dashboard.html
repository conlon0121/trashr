{% extends 'base.html' %}
{% load static %}
{% load bootstrap3 %}
{{ form.media }}
{% load render_table from django_tables2 %}

{% block content %}

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.16/af-2.2.2/b-1.4.2/r-2.2.0/sc-1.4.3/sl-1.2.3/datatables.min.css"/>

<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.16/af-2.2.2/b-1.4.2/r-2.2.0/sc-1.4.3/sl-1.2.3/datatables.min.js"></script>

 <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.css' rel='stylesheet' />


<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">Dashboard</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
    <div class="row">
        <div class="col-lg-6 col-md-6">
            <form id="form-select" method="post" action="{% url 'map' %}">
                <div class="hide">{% bootstrap_field form_select.dumpsters %}</div>
                <a id="graph" href="#">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-area-chart fa-5x"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge">Graph Selected Dumpsters</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </form>
        </div>
        <div class="col-lg-6 col-md-6">
            <a id="send-to-map" href="#">
                <div class="panel panel-green">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-xs-3">
                                <i class="fa fa-map-marker fa-5x"></i>
                            </div>
                            <div class="col-xs-9 text-right">
                                <div class="huge">Map Selected Dumpsters</div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <div class="row">
        <div id="table" class="col-md-6" style="visibility:hidden">
            {% include 'table.html' %}
        </div>
        <div class="col-md-6">
            <div id='map' style='width: 100%; height: 100%;'></div>
        </div>
    </div>
</div>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoidHJhc2hyIiwiYSI6ImNqOHJ3MDBzZjAyZTgzNG1yNHpmZDl3Y2sifQ.q574EBc3GMSMHBH2sPGM6w';
  var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/streets-v9',
    zoom: 13.7,
    center: [-78.681,35.781]
});

map.on('load', function () {
    // Add a layer showing the places.
    map.addLayer({{layer|safe}});

    // When a click event occurs on a feature in the places layer, open a popup at the
    // location of the feature, with description HTML from its properties.
    map.on('click', 'places', function (e) {
        new mapboxgl.Popup()
            .setLngLat(e.features[0].geometry.coordinates)
            .setHTML(e.features[0].properties.description)
            .addTo(map);
    });
});
    // Change the cursor to a pointer when the mouse is over the places layer.
    map.on('mouseenter', 'places', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'places', function () {
        map.getCanvas().style.cursor = '';
    });
  <!--map.on('click', function(e) {-->
    <!--var features = map.queryRenderedFeatures(e.point, {-->
      <!--layers: ['{{layer|safe}}'] // replace this with the name of the layer-->
    <!--});-->

    <!--if (!features.length) {-->
      <!--return;-->
    <!--}-->

    <!--var feature = features[0];-->

    <!--var popup = new mapboxgl.Popup({ offset: [0, -15] })-->
    <!--.setLngLat(feature.geometry.coordinates)-->
    <!--.setHTML('<h3>' + feature.properties.title + '</h3><p>' + feature.properties.description + '</p>')-->
    <!--.setLngLat(feature.geometry.coordinates)-->
    <!--.addTo(map);-->
    <!--})-->
</script>
<script>
$.fn.dataTable.ext.search.push(
  function( settings, data, dataIndex ) {
    var min = parseInt( $('#min').val(), 0 );
    var max = parseInt( $('#max').val(), 0 );
    var percent_fill = parseFloat( data[3] ) || 0;
  
    if ( ( isNaN( min )          && isNaN( max ) ) ||
         ( isNaN( min )          && percent_fill <= max ) ||
         ( min <= percent_fill   && isNaN( max ) ) ||
         ( min <= percent_fill   && percent_fill <= max ) ) {
      return true;
    }
    return false;
  }
);
$(document).ready(function() {
  var table = $('#dumpster-table').DataTable( {
    responsive:     true,
    columnDefs: [
     { responsivePriority: 1, targets: 0 },
     { responsivePriority: 1, targets: -1 },
     { responsivePriority: 3, targets: 2 },
     {
    } ],
    select: {
      style: 'multi',
    },
    order: [[ 3, 'desc' ]],
    dom: 'Bfrtip',
    buttons: [
        {
            extend: 'selectAll',
            className: 'selectall',
            action : function(e) {
                e.preventDefault();
                table.rows({ page: 'all'}).nodes().each(function() {
                    $(this).removeClass('selected')
                })
                table.rows({ search: 'applied'}).select();
            }
        },
        'selectNone',
    ],
    language: {
        buttons: {
            selectAll: "Select all",
            selectNone: "Select none"
        }
    },
  } );
  $('#min, #max').keyup(function() {
    table.draw();
  });

  $('#table').css('visibility', 'visible');
  $('#map').css('height', $('#table').css('height'));
} );

$('#send-to-map').click(function() {
  var arr = new Array(10)
  var count = 0;
  $('.check:checkbox:checked').each(function(){
    arr[count] = $(this).val();
    count++;
  });
  $('[name=dumpsters]').val(arr);
  $('#form-select').submit();
});

</script>
<style type="text/css">
@keyframes lds-eclipse {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  50% {
    -webkit-transform: rotate(180deg);
    transform: rotate(180deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@-webkit-keyframes lds-eclipse {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  50% {
    -webkit-transform: rotate(180deg);
    transform: rotate(180deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
.lds-eclipse {
  position: relative;
}
.lds-eclipse div {
  position: absolute;
  -webkit-animation: lds-eclipse 1s linear infinite;
  animation: lds-eclipse 1s linear infinite;
  width: 160px;
  height: 160px;
  top: 20px;
  left: 20px;
  border-radius: 50%;
  box-shadow: 0 4px 0 0 #2f98bb;
  -webkit-transform-origin: 80px 82px;
  transform-origin: 80px 82px;
}
.lds-eclipse {
  width: 200px !important;
  height: 200px !important;
  -webkit-transform: translate(-100px, -100px) scale(1) translate(100px, 100px);
  transform: translate(-100px, -100px) scale(1) translate(100px, 100px);
}
.hide {
  display: none;
}
#map {
position: relative; !important
top: 0;
bottom: 0;
width: 100%;
}
</style>
{% endblock %}

